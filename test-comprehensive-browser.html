<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperParticles Comprehensive Test Suite</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: #0a0a0a; 
            color: #fff; 
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border-radius: 15px;
            border: 1px solid #333;
        }
        .container { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-panel { 
            background: #1a1a1a; 
            padding: 20px; 
            border: 1px solid #333; 
            border-radius: 10px;
            min-height: 400px;
        }
        .canvas-container { 
            grid-column: 1 / -1;
            text-align: center;
        }
        .test-section { 
            margin: 15px 0; 
            padding: 15px; 
            border: 1px solid #444; 
            border-radius: 8px;
            background: #222;
        }
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #4CAF50;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }
        button { 
            background: linear-gradient(135deg, #4CAF50, #45a049); 
            color: white; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px; 
            font-size: 13px;
            transition: all 0.3s ease;
        }
        button:hover { 
            background: linear-gradient(135deg, #45a049, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .output { 
            background: #2a2a2a; 
            padding: 12px; 
            border-radius: 6px; 
            margin: 10px 0; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 12px; 
            max-height: 200px; 
            overflow-y: auto; 
            border: 1px solid #444;
        }
        .success { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .info { color: #2196F3; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        canvas { 
            border: 2px solid #333; 
            background: #000; 
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .status { 
            padding: 12px; 
            background: #2a2a2a; 
            border-radius: 6px; 
            margin: 10px 0; 
            border-left: 4px solid #4CAF50;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        .test-results {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }
        .test-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .test-stat {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #444;
        }
        .test-stat .number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .test-stat .label {
            color: #aaa;
            font-size: 0.9em;
        }
        .auto-test-controls {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #222;
            border-radius: 10px;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ SuperParticles Comprehensive Test Suite</h1>
        <p>Automated testing of all API functions, edge cases, and integration scenarios</p>
    </div>

    <div class="auto-test-controls">
        <h3>üöÄ Automated Testing</h3>
        <button onclick="runAllTests()" id="runAllBtn">Run All Tests</button>
        <button onclick="stopAllTests()" id="stopAllBtn" disabled>Stop Tests</button>
        <button onclick="runSpecificTest()" id="runSpecificBtn">Run Specific Test</button>
        <select id="testSelector">
            <option value="basic">Basic API Functions</option>
            <option value="edge">Edge Cases</option>
            <option value="state">State Management</option>
            <option value="resize">Buffer Resizing</option>
            <option value="integration">Integration</option>
            <option value="performance">Performance</option>
        </select>
    </div>

    <div class="container">
        <div class="test-panel">
            <div class="test-section">
                <h3>üéÆ Particle System Controls</h3>
                <button onclick="initParticles()" id="initBtn">Initialize Particles</button>
                <button onclick="stopParticles()" id="stopBtn" disabled>Stop Particles</button>
                <button onclick="resetParticles()" id="resetBtn">Reset to Defaults</button>
                <div class="status" id="system-status">System: Not initialized</div>
            </div>

            <div class="test-section">
                <h3>‚öôÔ∏è Manual API Testing</h3>
                <button onclick="testSpeedChange()">Change Speed</button>
                <button onclick="testParticleCount()">Change Count</button>
                <button onclick="testDeterministic()">Toggle Deterministic</button>
                <button onclick="testColorChange()">Change Color</button>
                <button onclick="exportCurrentState()">Export State</button>
                <button onclick="importTestState()">Import Test State</button>
                <div class="output" id="manual-output">Ready for manual testing</div>
            </div>

            <div class="test-section">
                <h3>üìä Current Settings</h3>
                <div id="current-settings" class="output">No settings loaded</div>
            </div>
        </div>

        <div class="test-panel">
            <div class="test-section">
                <h3>üß™ Test Progress</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div id="test-progress">No tests running</div>
            </div>

            <div class="test-section">
                <h3>üìù Test Output</h3>
                <div class="output" id="test-output">Test output will appear here</div>
            </div>

            <div class="test-section">
                <h3>üîç Live Monitoring</h3>
                <div id="live-monitor" class="output">Monitoring particle system state...</div>
            </div>
        </div>
    </div>

    <div class="canvas-container">
        <h3>üé® Particle Canvas</h3>
        <canvas id="particleCanvas" width="800" height="500"></canvas>
        <div class="output" id="canvas-output">Canvas ready for particle system</div>
    </div>

    <div class="test-results">
        <h3>üìä Test Results Summary</h3>
        <div class="test-summary">
            <div class="test-stat">
                <div class="number" id="totalTests">0</div>
                <div class="label">Total Tests</div>
            </div>
            <div class="test-stat">
                <div class="number" id="passedTests">0</div>
                <div class="label">Passed</div>
            </div>
            <div class="test-stat">
                <div class="number" id="failedTests">0</div>
                <div class="label">Failed</div>
            </div>
            <div class="test-stat">
                <div class="number" id="successRate">0%</div>
                <div class="label">Success Rate</div>
            </div>
        </div>
        <div class="output" id="detailed-results">Detailed results will appear here</div>
    </div>

    <script type="module">
        // Import from the built JavaScript file
        import { init, setOptions, exportState, importState } from './dist/index.js';
        
        let engine = null;
        let currentSettings = {
            color: '#70c1ff',
            speed: 40,
            particleCount: 1000,
            deterministic: false,
            useWebGL: false,
            useWebGPU: false
        };
        
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            details: []
        };
        
        let isTestRunning = false;
        let currentTestSuite = null;

        // Global functions for testing - make them available on window
        window.initParticles = async function() {
            const output = document.getElementById('canvas-output');
            const status = document.getElementById('system-status');
            const initBtn = document.getElementById('initBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            try {
                output.innerHTML = '<span class="info">üîÑ Initializing particle system...</span>';
                status.innerHTML = 'System: Initializing...';
                initBtn.disabled = true;
                
                const canvas = document.getElementById('particleCanvas');
                engine = await init(canvas, currentSettings);
                
                output.innerHTML = '<span class="success">‚úÖ Particle system initialized!</span>';
                status.innerHTML = 'System: Running';
                stopBtn.disabled = false;
                
                updateSettingsDisplay();
                startLiveMonitoring();
                
            } catch (error) {
                output.innerHTML = `<span class="error">‚ùå Initialization failed: ${error.message}</span>`;
                status.innerHTML = 'System: Failed';
                initBtn.disabled = false;
            }
        };

        window.stopParticles = function() {
            const output = document.getElementById('canvas-output');
            const status = document.getElementById('system-status');
            const initBtn = document.getElementById('initBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (engine) {
                engine.stop();
                engine = null;
                output.innerHTML = '<span class="info">‚èπÔ∏è Particle system stopped</span>';
                status.innerHTML = 'System: Stopped';
                stopBtn.disabled = true;
                initBtn.disabled = false;
                stopLiveMonitoring();
            } else {
                output.innerHTML = '<span class="error">‚ùå No system running</span>';
            }
        };

        window.resetParticles = function() {
            const output = document.getElementById('manual-output');
            try {
                importState({
                    color: '#70c1ff',
                    speed: 40,
                    particleCount: 1000,
                    deterministic: false,
                    useWebGL: false,
                    useWebGPU: false
                });
                currentSettings = exportState();
                updateSettingsDisplay();
                output.innerHTML = '<span class="success">‚úÖ Reset to default settings</span>';
            } catch (error) {
                output.innerHTML = `<span class="error">‚ùå Reset failed: ${error.message}</span>`;
            }
        };

        // Manual testing functions
        window.testSpeedChange = function() {
            const output = document.getElementById('manual-output');
            try {
                const newSpeed = Math.floor(Math.random() * 100) + 20;
                setOptions({ speed: newSpeed });
                currentSettings.speed = newSpeed;
                output.innerHTML = `<span class="success">‚úÖ Speed changed to: ${newSpeed}</span>`;
                updateSettingsDisplay();
            } catch (error) {
                output.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        window.testParticleCount = function() {
            const output = document.getElementById('manual-output');
            try {
                const newCount = Math.floor(Math.random() * 3000) + 500;
                setOptions({ particleCount: newCount });
                currentSettings.particleCount = newCount;
                output.innerHTML = `<span class="success">‚úÖ Particle count changed to: ${newCount}</span>`;
                updateSettingsDisplay();
            } catch (error) {
                output.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        window.testDeterministic = function() {
            const output = document.getElementById('manual-output');
            try {
                const newDeterministic = !currentSettings.deterministic;
                setOptions({ deterministic: newDeterministic });
                currentSettings.deterministic = newDeterministic;
                output.innerHTML = `<span class="success">‚úÖ Deterministic: ${newDeterministic}</span>`;
                updateSettingsDisplay();
            } catch (error) {
                output.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        window.testColorChange = function() {
            const output = document.getElementById('manual-output');
            try {
                const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'];
                const newColor = colors[Math.floor(Math.random() * colors.length)];
                setOptions({ color: newColor });
                currentSettings.color = newColor;
                output.innerHTML = `<span class="success">‚úÖ Color changed to: ${newColor}</span>`;
                updateSettingsDisplay();
            } catch (error) {
                output.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        window.exportCurrentState = function() {
            const output = document.getElementById('manual-output');
            try {
                const state = exportState();
                output.innerHTML = `<span class="success">‚úÖ State exported:</span>\n${JSON.stringify(state, null, 2)}`;
            } catch (error) {
                output.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        window.importTestState = function() {
            const output = document.getElementById('manual-output');
            try {
                const testState = { 
                    speed: 80, 
                    particleCount: 1500, 
                    deterministic: true,
                    color: '#ff6b6b' 
                };
                importState(testState);
                currentSettings = { ...currentSettings, ...testState };
                output.innerHTML = `<span class="success">‚úÖ Test state imported:</span>\n${JSON.stringify(testState, null, 2)}`;
                updateSettingsDisplay();
            } catch (error) {
                output.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        };

        // Automated testing functions
        window.runAllTests = async function() {
            if (isTestRunning) return;
            
            isTestRunning = true;
            document.getElementById('runAllBtn').disabled = true;
            document.getElementById('stopAllBtn').disabled = false;
            
            resetTestResults();
            
            const testSuites = [
                { name: 'Basic API Functions', func: testBasicAPIFunctions },
                { name: 'Edge Cases', func: testEdgeCases },
                { name: 'State Management', func: testStateManagement },
                { name: 'Buffer Resizing', func: testBufferResizing },
                { name: 'Integration', func: testIntegration },
                { name: 'Performance', func: testPerformance }
            ];
            
            for (let i = 0; i < testSuites.length; i++) {
                if (!isTestRunning) break;
                
                currentTestSuite = testSuites[i];
                updateProgress((i / testSuites.length) * 100);
                updateTestProgress(`Running: ${currentTestSuite.name}`);
                
                try {
                    await currentTestSuite.func();
                } catch (error) {
                    logTestOutput(`<span class="error">‚ùå Test suite failed: ${error.message}</span>`);
                }
            }
            
            if (isTestRunning) {
                updateProgress(100);
                updateTestProgress('All tests completed');
                finalizeTestResults();
            }
            
            isTestRunning = false;
            document.getElementById('runAllBtn').disabled = false;
            document.getElementById('stopAllBtn').disabled = true;
        };

        window.stopAllTests = function() {
            isTestRunning = false;
            updateTestProgress('Tests stopped by user');
            document.getElementById('runAllBtn').disabled = false;
            document.getElementById('stopAllBtn').disabled = true;
        };

        window.runSpecificTest = function() {
            const testType = document.getElementById('testSelector').value;
            const testMap = {
                'basic': testBasicAPIFunctions,
                'edge': testEdgeCases,
                'state': testStateManagement,
                'resize': testBufferResizing,
                'integration': testIntegration,
                'performance': testPerformance
            };
            
            if (testMap[testType]) {
                resetTestResults();
                testMap[testType]().then(() => {
                    finalizeTestResults();
                });
            }
        };

        // Test suite implementations
        async function testBasicAPIFunctions() {
            logTestOutput('<span class="info">üß™ Testing Basic API Functions...</span>');
            
            // Test setOptions
            await runTest('setOptions - speed change', () => {
                const originalSpeed = currentSettings.speed;
                setOptions({ speed: 80 });
                return currentSettings.speed === 80;
            });
            
            await runTest('setOptions - color change', () => {
                setOptions({ color: '#ff0000' });
                return currentSettings.color === '#ff0000';
            });
            
            await runTest('setOptions - particleCount change', () => {
                setOptions({ particleCount: 2000 });
                return currentSettings.particleCount === 2000;
            });
            
            await runTest('setOptions - deterministic change', () => {
                setOptions({ deterministic: true });
                return currentSettings.deterministic === true;
            });
            
            // Test exportState
            await runTest('exportState - returns copy', () => {
                const state = exportState();
                state.speed = 999;
                return currentSettings.speed !== 999;
            });
            
            // Test importState
            await runTest('importState - applies all options', () => {
                const testState = { 
                    speed: 100, 
                    particleCount: 3000, 
                    deterministic: true,
                    color: '#00ff00' 
                };
                importState(testState);
                return currentSettings.speed === 100 && currentSettings.particleCount === 3000;
            });
        }

        async function testEdgeCases() {
            logTestOutput('<span class="info">üß™ Testing Edge Cases...</span>');
            
            await runTest('Empty options', () => {
                const originalState = { ...currentSettings };
                setOptions({});
                return JSON.stringify(currentSettings) === JSON.stringify(originalState);
            });
            
            await runTest('Undefined values', () => {
                const originalState = { ...currentSettings };
                setOptions({ speed: undefined, particleCount: undefined });
                return JSON.stringify(currentSettings) === JSON.stringify(originalState);
            });
            
            await runTest('Same particle count', () => {
                const originalCount = currentSettings.particleCount;
                setOptions({ particleCount: originalCount });
                return currentSettings.particleCount === originalCount;
            });
            
            await runTest('Extreme values', () => {
                setOptions({ speed: 0, particleCount: 1000000 });
                return currentSettings.speed === 0 && currentSettings.particleCount === 1000000;
            });
        }

        async function testStateManagement() {
            logTestOutput('<span class="info">üß™ Testing State Management...</span>');
            
            await runTest('State round-trip', () => {
                const originalState = exportState();
                setOptions({ speed: 999, particleCount: 9999 });
                importState(originalState);
                const restoredState = exportState();
                return JSON.stringify(restoredState) === JSON.stringify(originalState);
            });
            
            await runTest('Partial state import', () => {
                const originalState = exportState();
                const partialState = { speed: 150, deterministic: false };
                importState(partialState);
                return currentSettings.speed === 150 && currentSettings.deterministic === false;
            });
        }

        async function testBufferResizing() {
            logTestOutput('<span class="info">üß™ Testing Buffer Resizing...</span>');
            
            await runTest('Increase particle count', () => {
                setOptions({ particleCount: 5000 });
                return currentSettings.particleCount === 5000;
            });
            
            await runTest('Decrease particle count', () => {
                setOptions({ particleCount: 500 });
                return currentSettings.particleCount === 500;
            });
            
            await runTest('Resize preserves other options', () => {
                setOptions({ speed: 75, color: '#ff00ff' });
                const beforeResize = { ...currentSettings };
                setOptions({ particleCount: 1000 });
                return currentSettings.speed === beforeResize.speed && currentSettings.color === beforeResize.color;
            });
        }

        async function testIntegration() {
            logTestOutput('<span class="info">üß™ Testing Integration...</span>');
            
            await runTest('Complete workflow', () => {
                const initialState = exportState();
                setOptions({ speed: 120, particleCount: 5000, useWebGL: true });
                setOptions({ speed: 20, particleCount: 500, useWebGL: false });
                importState(initialState);
                const restoredState = exportState();
                return JSON.stringify(restoredState) === JSON.stringify(initialState);
            });
        }

        async function testPerformance() {
            logTestOutput('<span class="info">üß™ Testing Performance...</span>');
            
            await runTest('Rapid state changes', () => {
                const startTime = Date.now();
                for (let i = 0; i < 50; i++) {
                    setOptions({ 
                        speed: i % 100, 
                        particleCount: 1000 + (i % 1000),
                        deterministic: i % 2 === 0 
                    });
                }
                const duration = Date.now() - startTime;
                logTestOutput(`    ‚è±Ô∏è  Duration: ${duration}ms`);
                return duration < 2000;
            });
        }

        // Test helper functions
        async function runTest(testName, testFunction) {
            if (!isTestRunning) return;
            
            testResults.total++;
            logTestOutput(`üîç Running: ${testName}`);
            
            try {
                const result = await testFunction();
                if (result === true) {
                    testResults.passed++;
                    logTestOutput(`  ‚úÖ PASSED: ${testName}`);
                    testResults.details.push({ name: testName, status: 'PASSED', error: null });
                } else {
                    testResults.failed++;
                    logTestOutput(`  ‚ùå FAILED: ${testName}`);
                    testResults.details.push({ name: testName, status: 'FAILED', error: 'Test returned false' });
                }
            } catch (error) {
                testResults.failed++;
                logTestOutput(`  üí• ERROR: ${testName} - ${error.message}`);
                testResults.details.push({ name: testName, status: 'ERROR', error: error.message });
            }
            
            updateTestCounters();
            await new Promise(resolve => setTimeout(resolve, 100)); // Small delay for visual feedback
        }

        function resetTestResults() {
            testResults = { total: 0, passed: 0, failed: 0, details: [] };
            updateTestCounters();
            updateProgress(0);
            logTestOutput('<span class="info">üßπ Test results reset</span>');
        }

        function finalizeTestResults() {
            const successRate = testResults.total > 0 ? ((testResults.passed / testResults.total) * 100).toFixed(1) : 0;
            
            logTestOutput(`\n<span class="info">üìä FINAL RESULTS:</span>`);
            logTestOutput(`Total: ${testResults.total}, Passed: ${testResults.passed}, Failed: ${testResults.failed}`);
            logTestOutput(`Success Rate: ${successRate}%`);
            
            if (testResults.failed === 0) {
                logTestOutput('<span class="success">üéâ ALL TESTS PASSED!</span>');
            } else {
                logTestOutput('<span class="warning">‚ö†Ô∏è  Some tests failed. Check details above.</span>');
            }
            
            updateDetailedResults();
        }

        // UI update functions
        function updateSettingsDisplay() {
            const display = document.getElementById('current-settings');
            display.innerHTML = `Speed: ${currentSettings.speed}\nParticles: ${currentSettings.particleCount}\nDeterministic: ${currentSettings.deterministic}\nColor: ${currentSettings.color}\nWebGL: ${currentSettings.useWebGL}\nWebGPU: ${currentSettings.useWebGPU}`;
        }

        function updateProgress(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        function updateTestProgress(message) {
            document.getElementById('test-progress').innerHTML = message;
        }

        function logTestOutput(message) {
            const output = document.getElementById('test-output');
            output.innerHTML += message + '\n';
            output.scrollTop = output.scrollHeight;
        }

        function updateTestCounters() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            
            const successRate = testResults.total > 0 ? ((testResults.passed / testResults.total) * 100).toFixed(1) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        function updateDetailedResults() {
            const output = document.getElementById('detailed-results');
            let html = '<h4>Test Details:</h4>';
            
            testResults.details.forEach(test => {
                const statusIcon = test.status === 'PASSED' ? '‚úÖ' : test.status === 'FAILED' ? '‚ùå' : 'üí•';
                const statusClass = test.status === 'PASSED' ? 'success' : 'error';
                html += `<div class="${statusClass}">${statusIcon} ${test.name}</div>`;
                if (test.error) {
                    html += `<div style="margin-left: 20px; color: #aaa;">Error: ${test.error}</div>`;
                }
            });
            
            output.innerHTML = html;
        }

        // Live monitoring
        let monitoringInterval = null;

        function startLiveMonitoring() {
            monitoringInterval = setInterval(() => {
                if (engine && isTestRunning) {
                    const monitor = document.getElementById('live-monitor');
                    const state = exportState();
                    monitor.innerHTML = `Active Tests: ${isTestRunning ? 'Yes' : 'No'}\nCurrent Suite: ${currentTestSuite ? currentTestSuite.name : 'None'}\nParticles: ${state.particleCount}\nSpeed: ${state.speed}\nDeterministic: ${state.deterministic}`;
                }
            }, 1000);
        }

        function stopLiveMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }

        // Initialize
        updateSettingsDisplay();
        
        console.log('üß™ Comprehensive test suite loaded');
        console.log('Available functions:', { init, setOptions, exportState, importState });
    </script>
</body>
</html>
